## Kindle書籍管理アプリ 技術構成案 (Flutterオンリー版)

Flutterアプリ単体で、`kindle.csv` の処理、LLM連携、データ永続化、表示・フィルタリング機能を実現する構成案です。

### 1. モバイルアプリケーション (Flutter)

* **主な役割**:
  * UI/UXの提供 (書籍一覧、詳細表示、フィルタリングUI、データ処理実行UI)
  * `kindle.csv` ファイルの読み込みとパース
  * LLM (OpenAI API, Gemini API等) への直接的なAPIリクエストとレスポンス処理
  * SQLiteデータベースへのデータ保存と読み出し
  * 書籍データのフィルタリングロジック

* **使用する主要パッケージ/技術**:
  * **UIフレームワーク**: Flutter SDK
  * **状態管理**: `flutter_riverpod`
  * **HTTP通信**: `dio` (LLM APIとの通信用)
  * **ローカルデータベース**: `sqflite`
  * **CSVパース**: `csv` パッケージ
  * **ファイルピッカー**: `file_picker` (ユーザーに`kindle.csv`を選択させる場合)
  * **パスプロバイダ**: `path_provider` (アプリのローカルストレージへのパス取得用)
  * **バックグラウンド処理**: (任意) `compute`関数や `flutter_isolate` (LLM処理が重い場合)

* **データ処理フロー**:
    1. **CSV読み込み**:
      *アプリ起動時またはユーザー操作により、`kindle.csv` を読み込みます。
      *  CSVファイルは、アプリの `assets` に同梱するか、ユーザーにファイルを選択させる形になります。
    2. **LLM連携による情報付加**:
      *  各書籍データ (タイトル、著者名) を基に、LLM APIへリクエストを送信します。
          * **ジャンル推定**: LLMに書籍のジャンルを推定させます。
          * **キーワード抽出**: LLMに書籍に関連するキーワードを抽出させます。
          * **(オプション) カバー画像生成**: LLMに書籍のイメージに合う画像を生成させ、アプリのローカルストレージに保存します。
      *  LLMからのレスポンスをパースし、情報を取得します。
    3. **SQLiteへの保存**:
      *CSV由来のデータとLLMが付加した情報 (ジャンル、キーワード、画像パス等) をSQLiteデータベースに保存します。
      *  既に処理済みの書籍はスキップする、または更新するロジックを設けます。
    4. **表示とフィルタリング**:
      *SQLiteから書籍データを読み出し、リスト形式で表示します。
      *  書籍名、購入日 (`date` カラム)、ジャンル、読了状態 (`status` カラム) などでユーザーがフィルタリングできるようにします。

* **SQLiteテーブル設計 (例: `books`テーブル)**:
  * `id` (INTEGER, PRIMARY KEY AUTOINCREMENT): ユニークID
  * `title` (TEXT): 書籍タイトル
  * `authors` (TEXT): 著者名
  * `purchase_date` (TEXT): 購入日 (ISO8601形式などで保存推奨)
  * `status` (TEXT): 読了状態 ("READ", "UNKNOWN"など)
  * `genre` (TEXT): LLMが推定したジャンル (カンマ区切りやJSON文字列で複数格納も可)
  * `keywords` (TEXT): LLMが抽出したキーワード (カンマ区切りやJSON文字列)
  * `cover_image_path` (TEXT): (オプション) 生成したカバー画像のローカルファイルパス

### 2. LLM (Large Language Model)

* **役割**:
  * 書籍情報に基づくジャンル推定
  * 書籍情報に基づくキーワード抽出
  * (オプション) 書籍情報を基にしたイメージ画像生成
* **利用候補**:
  * **テキスト処理**: OpenAI API (GPT-4o, GPT-3.5-turbo), Google Gemini API など
  * **画像生成**: OpenAI DALL-E API, Stability AI API など
* **連携方法**:
  * Flutterアプリから直接、各LLMプロバイダのREST APIを呼び出します。
  * APIリクエスト時には、認証情報 (APIキー) が必要になります。

### 注意事項・懸念事項

* **APIキーの管理**:
  * LLMのAPIキーをクライアントアプリ内に直接ハードコードするのはセキュリティ上非常に危険です。
  * **対策案**:
        1. **ユーザー入力**: アプリ設定画面などでユーザー自身にAPIキーを入力してもらう。
        2. **(非推奨に近い)** ビルド時の環境変数経由で注入（ただし、リバースエンジニアリングのリスクは残ります）。
        3. **将来的検討**: もしアプリを配布する段階になったら、APIキーを保護するために最小限のサーバーレス関数 (Firebase Functions, AWS Lambdaなど) を仲介させる構成も検討の余地があります。今回の要件ではバックエンド不要とのことなので、まずはユーザー入力方式を推奨します。
* **LLM処理の実行時間とコスト**:
  * 多数の書籍に対してLLM APIを呼び出すと、処理に時間がかかり、またAPI利用料金も発生します。
  * **対策案**:
        1. **バックグラウンド処理**: Flutterの `compute` 関数などを用いてUIのフリーズを防ぎます。
        2. **進捗表示**: ユーザーに処理状況がわかるようにプログレスバーなどを表示します。
        3. **差分処理**: 一度処理した書籍はSQLiteに保存し、次回からは未処理の書籍のみを対象とする、または更新が必要な書籍のみを対象とするロジックを組み込みます。
        4. **APIリクエストの最適化**: 複数の書籍情報をまとめてリクエストできる場合はAPIの仕様を確認し、効率化を図ります。
* **CSVファイルの取り扱い**:
  * `assets` に同梱する場合、アプリのアップデートなしにCSVを更新できません。
  * ユーザーにファイル選択させる場合、適切なファイルアクセス権限の処理が必要です。

1. **使用するLLM**: Gemini API
2. **APIキーの管理方法**: ユーザー入力方式 or .env
3. **`kindle.csv`の提供方法**: (例: `assets` に同梱し、初期データとしては利用しない、kindle.csvからデータを作成する)
